{{template "base" .}}

{{define "content"}}
<div class="home-container">
    <div class="page-header">
        <div class="header-left">
            <button class="notification-btn" id="notificationBtn" onclick="openNotifications()" title="Notifications">
                <img src="/icon/bell" class="notification-icon" alt="Notifications">
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
        </div>
        <div class="header-actions">
            <a href="/calendar" class="page-nav-btn"><img src="/icon/calendar-days" class="nav-icon" alt="">Calendar</a>
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
        </div>
    </div>
    {{if or .Groups .Cameras}}
    <div class="groups-grid">
        {{range $idx, $group := .Groups}}
        <div class="group-card" onclick="openGroupModal('{{$group.Name}}')" data-group="{{$group.Name}}">
            <div class="group-card-icon">{{if eq $group.Name "Tesla"}}<img src="/icon/tesla-svgrepo-com" class="group-icon group-icon-tesla" alt="">{{else if eq $group.Name "Security"}}<img src="/icon/lock" class="group-icon" alt="">{{else if eq $group.Name "Home"}}<img src="/icon/house-chimney" class="group-icon" alt="">{{else if eq $group.Name "Climate"}}<img src="/icon/temperature-high" class="group-icon" alt="">{{else if eq $group.Name "Lights"}}<img src="/icon/lightbulb" class="group-icon" alt="">{{else}}{{$group.Icon}}{{end}}</div>
            <div class="group-card-info">
                <div class="group-card-name">{{$group.Name}}</div>
                <div class="group-card-summary" id="summary-{{$group.Name}}">
                    {{len $group.Cards}} device{{if ne (len $group.Cards) 1}}s{{end}}
                </div>
            </div>
            <div class="group-card-arrow">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </div>
        </div>
        {{end}}
        <!-- Hue Lights Card -->
        <div class="group-card" onclick="openHueModal()" data-group="Hue">
            <div class="group-card-icon"><img src="/icon/lightbulb" class="group-icon" alt=""></div>
            <div class="group-card-info">
                <div class="group-card-name"><img src="/icon/philipshue-svgrepo-com" class="hue-logo" alt="Philips Hue"></div>
                <div class="group-card-summary" id="summary-Hue">Loading...</div>
            </div>
            <div class="group-card-arrow">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </div>
        </div>
        <!-- Spotify Card -->
        <div class="group-card" onclick="openSpotifyModal()" data-group="Spotify" id="spotifyCard" style="display: none;">
            <div class="group-card-icon"><img src="/icon/spotify" class="group-icon group-icon-spotify" alt=""></div>
            <div class="group-card-info">
                <div class="group-card-name">Spotify</div>
                <div class="group-card-summary" id="summary-Spotify">Not playing</div>
            </div>
            <div class="group-card-arrow">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </div>
        </div>
    </div>

    <!-- Hidden data for JavaScript -->
    <script id="groupsData" type="application/json">
    {{range $idx, $group := .Groups}}
    {{if $idx}},{{end}}
    {"name": "{{$group.Name}}", "icon": "{{$group.Icon}}", "cards": [
        {{range $cidx, $card := $group.Cards}}
        {{if $cidx}},{{end}}
        {
            "entityId": "{{$card.EntityID}}",
            "name": "{{$card.Name}}",
            "state": "{{$card.State}}",
            "icon": "{{$card.Icon}}",
            "type": "{{$card.Type}}",
            "unit": "{{$card.Unit}}",
            "isOn": {{$card.IsOn}},
            "isLightGroup": {{$card.IsLightGroup}},
            "members": [{{range $midx, $member := $card.Members}}{{if $midx}},{{end}}{
                "entityId": "{{$member.EntityID}}",
                "name": "{{$member.Name}}",
                "state": "{{$member.State}}",
                "icon": "{{$member.Icon}}",
                "type": "{{$member.Type}}",
                "isOn": {{$member.IsOn}}
            }{{end}}],
            "attributes": {{if $card.Attributes}}{{ $card.Attributes | json }}{{else}}{}{{end}}
        }
        {{end}}
    ]}
    {{end}}
    </script>
    <script id="camerasData" type="application/json">
    [{{range $idx, $cam := .Cameras}}{{if $idx}},{{end}}{"name": "{{$cam.name}}", "label": "{{$cam.label}}"}{{end}}]
    </script>
    {{else}}
    <div class="no-cards">
        <p>No entities configured.</p>
        <p>Set HA_ENTITIES in your environment.</p>
    </div>
    {{end}}
</div>

<!-- Group Modal -->
<div id="groupModal" class="modal">
    <div class="modal-content modal-group">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span id="groupModalIcon" class="group-modal-icon"></span>
                <h3 id="groupModalTitle"></h3>
            </div>
            <button class="modal-close-btn" onclick="closeGroupModal()">&times;</button>
        </div>
        <div id="groupModalContent" class="group-modal-content">
            <!-- Entities will be rendered here -->
        </div>
    </div>
</div>

<!-- Cameras Modal -->
<div id="camerasModal" class="modal">
    <div class="modal-content modal-cameras">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/video" class="group-modal-icon-img" alt="">
                <h3>Cameras</h3>
            </div>
            <button class="modal-close-btn" onclick="closeCamerasModal()">&times;</button>
        </div>
        <div id="camerasModalContent" class="cameras-modal-content">
            <!-- Cameras will be rendered here -->
        </div>
    </div>
</div>

<!-- Camera View Modal -->
<div id="cameraViewModal" class="modal camera-view-modal">
    <div class="modal-content modal-camera-view">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/video" class="group-modal-icon-img" alt="">
                <h3 id="cameraViewTitle">Camera</h3>
            </div>
            <button class="modal-close-btn" onclick="closeCameraViewModal()">&times;</button>
        </div>
        <div class="camera-view-container">
            <img id="cameraViewStream" class="camera-view-stream" alt="Camera stream">
            <div class="camera-view-loading">Loading camera...</div>
        </div>
        <div class="camera-view-actions">
            <button class="modal-btn secondary" onclick="closeCameraViewModal()">Close</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content modal-settings">
        <h3 class="modal-header">Settings</h3>

        <div class="settings-section">
            <h4 class="settings-section-title">Appearance</h4>
            <div class="form-group">
                <label>Theme</label>
                <div class="theme-options">
                    <button type="button" class="theme-option" data-theme="light" onclick="setTheme('light')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <span>Light</span>
                    </button>
                    <button type="button" class="theme-option active" data-theme="dark" onclick="setTheme('dark')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        <span>Dark</span>
                    </button>
                    <button type="button" class="theme-option" data-theme="auto" onclick="setTheme('auto')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 2a10 10 0 0 1 0 20"/>
                        </svg>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Time Format</label>
                <div class="time-format-toggle">
                    <button type="button" class="format-btn" data-format="12" onclick="setTimeFormat('12')">
                        12-Hour
                    </button>
                    <button type="button" class="format-btn active" data-format="24" onclick="setTimeFormat('24')">
                        24-Hour
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">Weather</h4>
            <div class="settings-info">
                {{if .WeatherConfigured}}
                <div class="weather-status connected">
                    <span class="status-dot"></span>
                    <span>Weather data enabled</span>
                </div>
                {{else}}
                <div class="weather-status disconnected">
                    <span class="status-dot"></span>
                    <span>Not configured</span>
                </div>
                <p class="settings-hint">Add OPENWEATHER_API_KEY to .env to enable weather features like sunrise/sunset times and moon phases.</p>
                {{end}}
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">About</h4>
            <p class="settings-hint">Home Control Kiosk v1.0</p>
        </div>

        <div class="modal-actions">
            <button type="button" class="modal-btn primary" onclick="closeSettings()">Done</button>
        </div>
    </div>
</div>

<!-- Hue Lights Modal (Full Screen) -->
<div id="hueModal" class="modal hue-modal">
    <div class="modal-content modal-hue-fullscreen">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/philipshue-svgrepo-com" class="hue-logo-modal" alt="Philips Hue">
                <img src="/icon/lightbulb" class="modal-header-lightbulb" alt="">
            </div>
            <button class="modal-close-btn" onclick="closeHueModal()">&times;</button>
        </div>
        <div id="hueModalContent" class="hue-modal-content">
            <div class="hue-loading">Loading lights...</div>
        </div>
    </div>
</div>

<!-- Spotify Modal (Full Screen) -->
<div id="spotifyModal" class="modal spotify-modal">
    <div class="modal-content modal-spotify-fullscreen">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/spotify" class="spotify-logo-modal" alt="Spotify">
                <h3>Spotify</h3>
            </div>
            <button class="modal-close-btn" onclick="closeSpotifyModal()">&times;</button>
        </div>
        <div id="spotifyModalContent" class="spotify-modal-content">
            <div class="spotify-loading">Loading...</div>
        </div>
    </div>
</div>

<!-- Spotify Playlist Modal -->
<div id="spotifyPlaylistModal" class="modal spotify-playlist-modal">
    <div class="modal-content modal-spotify-playlist">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/spotify" class="group-modal-icon-img spotify-icon" alt="">
                <h3 id="spotifyPlaylistTitle">Playlist</h3>
            </div>
            <button class="modal-close-btn" onclick="closeSpotifyPlaylistModal()">&times;</button>
        </div>
        <div id="spotifyPlaylistContent" class="spotify-playlist-content">
            <div class="spotify-loading">Loading tracks...</div>
        </div>
    </div>
</div>

<!-- Spotify Device Selector Modal -->
<div id="spotifyDeviceModal" class="modal spotify-device-modal">
    <div class="modal-content modal-spotify-device">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/volume-high" class="group-modal-icon-img" alt="">
                <h3>Select Device</h3>
            </div>
            <button class="modal-close-btn" onclick="closeSpotifyDeviceModal()">&times;</button>
        </div>
        <div id="spotifyDeviceContent" class="spotify-device-content">
            <div class="spotify-loading">Loading devices...</div>
        </div>
    </div>
</div>

<!-- Light Brightness Popup -->
<div id="lightBrightnessModal" class="modal light-brightness-modal">
    <div class="modal-content modal-light-brightness">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <img src="/icon/lightbulb" class="group-modal-icon-img" alt="">
                <h3 id="lightBrightnessTitle">Light</h3>
            </div>
            <button class="modal-close-btn" onclick="closeLightBrightnessPopup()">&times;</button>
        </div>
        <div class="light-brightness-content">
            <div class="light-brightness-toggle-row" onclick="toggleBrightnessPopupLight()">
                <span class="light-brightness-toggle-label">Power</span>
                <div class="toggle-switch" id="lightBrightnessToggle">
                    <div class="toggle-slider"></div>
                </div>
            </div>
            <div class="light-brightness-slider-container">
                <input type="range" id="lightBrightnessSlider" min="1" max="254" value="127"
                       oninput="updateLightBrightnessPreview(this.value)"
                       onchange="setLightBrightness(this.value)">
                <span id="lightBrightnessPercent" class="light-brightness-percent">50%</span>
            </div>
            <div class="light-brightness-actions">
                <button class="modal-btn secondary" onclick="closeLightBrightnessPopup()">Done</button>
            </div>
        </div>
    </div>
</div>

<!-- Scene Selection Popup -->
<div id="sceneModal" class="modal scene-modal">
    <div class="modal-content modal-scene">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span class="group-modal-icon">ðŸŽ¬</span>
                <h3 id="sceneModalTitle">Scenes</h3>
            </div>
            <button class="modal-close-btn" onclick="closeSceneModal()">&times;</button>
        </div>
        <div class="scene-modal-content">
            <div id="sceneModalList" class="scene-modal-list">
                <!-- Scenes will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Sync Mode Modal -->
<div id="syncModeModal" class="modal syncbox-modal">
    <div class="modal-content modal-syncbox">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span class="group-modal-icon">ðŸŽ¬</span>
                <h3>Sync Mode</h3>
            </div>
            <button class="modal-close-btn" onclick="closeSyncModeModal()">&times;</button>
        </div>
        <div class="syncbox-modal-options">
            <!-- Options populated by JS -->
        </div>
    </div>
</div>

<!-- HDMI Input Modal -->
<div id="hdmiInputModal" class="modal syncbox-modal">
    <div class="modal-content modal-syncbox">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span class="group-modal-icon">ðŸ“º</span>
                <h3>HDMI Input</h3>
            </div>
            <button class="modal-close-btn" onclick="closeHdmiInputModal()">&times;</button>
        </div>
        <div class="syncbox-modal-options">
            <!-- Options populated by JS -->
        </div>
    </div>
</div>


<!-- Camera Modal -->
<div id="cameraModal" class="modal camera-modal">
    <div class="modal-content modal-camera">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span class="camera-modal-icon">ðŸ””</span>
                <h3 id="cameraModalTitle">Doorbell</h3>
            </div>
            <button class="modal-close-btn" onclick="closeCameraModal()">&times;</button>
        </div>
        <div class="camera-stream-container">
            <img id="cameraStream" class="camera-stream" alt="Camera stream">
            <div class="camera-loading">Loading camera...</div>
        </div>
        <div class="camera-modal-actions">
            <button class="modal-btn secondary" onclick="closeCameraModal()">Dismiss</button>
        </div>
    </div>
</div>

<!-- Spotify Mini Player Banner -->
<div id="spotifyMiniPlayer" class="spotify-mini-player" style="display: none;" onclick="handleMiniPlayerClick(event)">
    <div class="spotify-mini-art" id="spotifyMiniArt"></div>
    <div class="spotify-mini-info" id="spotifyMiniInfo">
        <div class="spotify-mini-track">Not playing</div>
        <div class="spotify-mini-artist"></div>
    </div>
    <div class="spotify-mini-controls">
        <button class="spotify-mini-btn" onclick="event.stopPropagation(); spotifyPrevious();">
            <img src="/icon/backward-step" alt="Previous">
        </button>
        <button class="spotify-mini-btn spotify-mini-play" id="spotifyMiniPlayBtn" onclick="event.stopPropagation(); toggleSpotifyPlayback();">
            <img src="/icon/play" alt="Play" id="spotifyMiniPlayIcon">
        </button>
        <button class="spotify-mini-btn" onclick="event.stopPropagation(); spotifyNext();">
            <img src="/icon/forward-step" alt="Next">
        </button>
    </div>
    <div class="spotify-mini-volume" onclick="event.stopPropagation();">
        <img src="/icon/volume-high" class="spotify-mini-volume-icon" id="spotifyMiniVolumeIcon" alt="Volume" onclick="toggleMute()" style="cursor:pointer">
        <input type="range" class="spotify-mini-volume-slider" id="spotifyMiniVolumeSlider" min="0" max="100" value="50"
               oninput="onVolumeInput(this)">
    </div>
    <button class="spotify-mini-device-btn" id="spotifyMiniDeviceBtn" onclick="event.stopPropagation(); openSpotifyDeviceModal();">
        <img src="/icon/speaker" alt="Device">
        <span id="spotifyMiniDeviceName">No device</span>
    </button>
    <div class="spotify-mini-progress">
        <div class="spotify-mini-progress-fill" id="spotifyMiniProgressFill"></div>
    </div>
</div>

<!-- Screensaver Overlay -->
<div id="screensaver" class="screensaver">
    <div class="screensaver-bg"></div>
    <div class="screensaver-bg screensaver-bg-next"></div>
    <div class="screensaver-clock">
        <div class="screensaver-time" id="screensaverTime">12:00</div>
        <div class="screensaver-date" id="screensaverDate">Monday, January 1</div>
    </div>
    <div class="screensaver-spotify" id="screensaverSpotify" style="display: none;">
        <img src="/icon/spotify" class="screensaver-spotify-icon" alt="">
        <div class="screensaver-spotify-art" id="screensaverSpotifyArt"></div>
        <div class="screensaver-spotify-info">
            <div class="screensaver-spotify-track" id="screensaverSpotifyTrack"></div>
            <div class="screensaver-spotify-artist" id="screensaverSpotifyArtist"></div>
        </div>
    </div>
</div>

<!-- Background Image Container -->
<div id="pageBackground" class="page-background"></div>

<!-- Entities/Groups Module -->
<script src="/static/js/entities.js"></script>
<!-- Settings Module -->
<script src="/static/js/settings.js"></script>
<!-- Hue Module -->
<script src="/static/js/hue.js"></script>
<!-- Spotify Module -->
<script src="/static/js/spotify.js"></script>
<!-- Camera/WebSocket Module -->
<script src="/static/js/camera.js"></script>
<!-- Screensaver Module -->
<script src="/static/js/screensaver.js"></script>
{{end}}
