{{template "base" .}}

{{define "content"}}
<div class="home-container">
    <div class="page-header">
        <div class="header-actions">
            <a href="/calendar" class="page-nav-btn">Calendar</a>
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
        </div>
    </div>
    {{if .Groups}}
    {{range .Groups}}
    <div class="card-group">
        <h2 class="group-header">
            <span class="group-icon">{{.Icon}}</span>
            {{.Name}}
        </h2>
        <div class="cards-grid">
            {{range .Cards}}
            <div class="card card-{{.Type}}{{if .IsOn}} card-on{{end}}"
                 data-entity="{{.EntityID}}"
                 {{if or (eq .Type "light") (eq .Type "switch") (eq .Type "fan") (eq .Type "lock")}}onclick="toggleEntity('{{.EntityID}}')"{{end}}>
                <div class="card-icon">{{.Icon}}</div>
                <div class="card-info">
                    <div class="card-name">{{.Name}}</div>
                    <div class="card-state">{{.State}}{{if .Unit}} {{.Unit}}{{end}}</div>
                </div>
            </div>
            {{end}}
        </div>
    </div>
    {{end}}
    {{else}}
    <div class="no-cards">
        <p>No entities configured.</p>
        <p>Set HA_ENTITIES in your environment.</p>
    </div>
    {{end}}
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content modal-settings">
        <h3 class="modal-header">Settings</h3>

        <div class="settings-section">
            <h4 class="settings-section-title">Appearance</h4>
            <div class="form-group">
                <label>Theme</label>
                <div class="theme-options">
                    <button type="button" class="theme-option" data-theme="light" onclick="setTheme('light')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <span>Light</span>
                    </button>
                    <button type="button" class="theme-option active" data-theme="dark" onclick="setTheme('dark')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        <span>Dark</span>
                    </button>
                    <button type="button" class="theme-option" data-theme="auto" onclick="setTheme('auto')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 2a10 10 0 0 1 0 20"/>
                        </svg>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Time Format</label>
                <div class="time-format-toggle">
                    <button type="button" class="format-btn" data-format="12" onclick="setTimeFormat('12')">
                        12-Hour
                    </button>
                    <button type="button" class="format-btn active" data-format="24" onclick="setTimeFormat('24')">
                        24-Hour
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">Weather</h4>
            <div class="settings-info">
                {{if .WeatherConfigured}}
                <div class="weather-status connected">
                    <span class="status-dot"></span>
                    <span>Weather data enabled</span>
                </div>
                {{else}}
                <div class="weather-status disconnected">
                    <span class="status-dot"></span>
                    <span>Not configured</span>
                </div>
                <p class="settings-hint">Add OPENWEATHER_API_KEY to .env to enable weather features like sunrise/sunset times and moon phases.</p>
                {{end}}
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">About</h4>
            <p class="settings-hint">Home Control Kiosk v1.0</p>
        </div>

        <div class="modal-actions">
            <button type="button" class="modal-btn primary" onclick="closeSettings()">Done</button>
        </div>
    </div>
</div>

<script>
async function toggleEntity(entityID) {
    const card = document.querySelector(`[data-entity="${entityID}"]`);
    card.classList.add('card-loading');

    try {
        const resp = await fetch(`/api/toggle/${entityID}`, { method: 'POST' });
        if (resp.ok) {
            const data = await resp.json();
            card.classList.toggle('card-on', data.IsOn);
            card.querySelector('.card-state').textContent = data.State;
        }
    } catch (err) {
        console.error('Toggle failed:', err);
    } finally {
        card.classList.remove('card-loading');
    }
}

// Settings Functions
function openSettings() {
    const modal = document.getElementById('settingsModal');
    modal.classList.add('active');
    loadThemeSetting();
    loadTimeFormatSetting();
}

function closeSettings() {
    document.getElementById('settingsModal').classList.remove('active');
}

// Time Format Functions
function getTimeFormat() {
    return localStorage.getItem('timeFormat') || '12';
}

function setTimeFormat(format) {
    localStorage.setItem('timeFormat', format);
    document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.format === format);
    });
}

function loadTimeFormatSetting() {
    const format = getTimeFormat();
    document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.format === format);
    });
}

function setTheme(theme) {
    localStorage.setItem('theme', theme);
    applyTheme(theme);

    // Update button states
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
    });
}

function loadThemeSetting() {
    const theme = localStorage.getItem('theme') || 'dark';
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
    });
}

function applyTheme(theme) {
    if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
}

// Apply theme on load
(function() {
    const theme = localStorage.getItem('theme') || 'dark';
    applyTheme(theme);
})();

// Listen for system theme changes when in auto mode
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const theme = localStorage.getItem('theme');
    if (theme === 'auto') {
        applyTheme('auto');
    }
});

// Auto-refresh every 30 seconds
setInterval(() => location.reload(), 30000);

// Close modals when clicking outside (on the backdrop)
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});
</script>
{{end}}
