{{template "base" .}}

{{define "content"}}
<div class="calendar-container">
    {{if not .Authorized}}
    <div class="page-header">
        <a href="/home" class="page-nav-btn"><img src="/icon/house-signal" class="nav-icon" alt="">Home</a>
    </div>
    <div class="auth-prompt">
        <h2>Google Calendar</h2>
        <p>Connect your Google Calendar to see upcoming events.</p>
        <a href="/auth/google" class="auth-button">Connect Google Calendar</a>
    </div>
    {{else}}
    <div class="calendar-header">
        <div class="view-toggle">
            <a href="?view=day&date={{.TodayDate}}" class="view-btn {{if eq .View "day"}}active{{end}}">Day</a>
            <a href="?view=week&date={{.TodayDate}}" class="view-btn {{if eq .View "week"}}active{{end}}">Week</a>
            <a href="?view=month&date={{.TodayDate}}" class="view-btn {{if eq .View "month"}}active{{end}}">Month</a>
        </div>
        <div class="header-actions">
            <a href="/home" class="page-nav-btn"><img src="/icon/house-signal" class="nav-icon" alt="">Home</a>
            <button class="settings-btn" onclick="openSettings()" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
            </button>
        </div>
    </div>

    {{if eq .View "month"}}
    <div class="month-view">
        <div class="view-title-nav">
            {{if .Calendars}}
            <div class="calendar-dropdown">
                <button type="button" class="calendar-dropdown-btn" onclick="toggleCalendarDropdown(event)">
                    <span>Calendars</span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="calendar-dropdown-menu">
                    {{range .Calendars}}
                    <div class="calendar-option" data-calendar-id="{{.ID}}">
                        <label class="calendar-checkbox">
                            <input type="checkbox" {{if .Visible}}checked{{end}}
                                   data-calendar-id="{{.ID}}"
                                   onchange="toggleCalendarVisibility('{{.ID}}', this.checked)">
                            <span class="checkmark" style="--cal-color: {{.Color}}"></span>
                        </label>
                        <span class="calendar-name">{{.Name}}</span>
                        <button type="button" class="calendar-color-btn"
                                style="background: {{.Color}}"
                                data-calendar-id="{{.ID}}"
                                data-current-color="{{.Color}}"
                                onclick="openColorPalette(event, '{{.ID}}')">
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
            <div class="view-title-row">
                <div class="view-title-left">
                    <button class="weather-widget" onclick="openWeatherModal()" title="Weather details">
                        <span class="weather-icon" id="weatherIconMonth"></span>
                        <span class="weather-temp" id="weatherTempMonth">--°</span>
                    </button>
                </div>
                <div class="view-title-center">
                    <a href="?view=month&date={{.PrevDate}}" class="nav-arrow"><img src="/icon/circle-arrow-left" alt="Previous"></a>
                    <h2 class="month-title" onclick="openDatePicker()">{{.MonthName}} {{.Year}}</h2>
                    <a href="?view=month&date={{.NextDate}}" class="nav-arrow"><img src="/icon/circle-arrow-right" alt="Next"></a>
                </div>
                <div class="view-title-right">
                    <button class="tasks-btn" onclick="toggleTasksPanel()" title="TODOs">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                        </svg>
                        <span>TODOs</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="weekday-row">
            <div class="weekday-header">Sun</div>
            <div class="weekday-header">Mon</div>
            <div class="weekday-header">Tue</div>
            <div class="weekday-header">Wed</div>
            <div class="weekday-header">Thu</div>
            <div class="weekday-header">Fri</div>
            <div class="weekday-header">Sat</div>
        </div>
        <div class="month-grid">
            {{range .MonthDays}}
            <div class="month-day {{if .IsToday}}today{{end}} {{if not .InMonth}}other-month{{end}}"
                 data-date="{{.Date.Format "2006-01-02"}}"
                 {{if gt .MoreCount 0}}data-all-events='[{{range $i, $e := .AllEvents}}{{if $i}},{{end}}{"id":"{{$e.ID}}","calendarId":"{{$e.CalendarID}}","title":"{{$e.Title}}","start":"{{$e.Start.Format "2006-01-02T15:04"}}","end":"{{$e.End.Format "2006-01-02T15:04"}}","allDay":{{$e.AllDay}},"location":"{{$e.Location}}","description":"{{$e.Description}}","colorId":"{{$e.ColorID}}","recurring":{{$e.Recurring}}}{{end}}]'{{end}}
                 onclick="openCreateModal(this.dataset.date)">
                <div class="day-number">{{.Day}}</div>
                {{range .Events}}
                <div class="month-event" {{if .Color}}style="background-color: {{.Color}}"{{end}}
                     data-event='{"id":"{{.ID}}","calendarId":"{{.CalendarID}}","title":"{{.Title}}","start":"{{.Start.Format "2006-01-02T15:04"}}","end":"{{.End.Format "2006-01-02T15:04"}}","allDay":{{.AllDay}},"location":"{{.Location}}","description":"{{.Description}}","colorId":"{{.ColorID}}","recurring":{{.Recurring}}}'
                     onclick="event.stopPropagation(); openEventDetails(this.dataset.event)">
                    {{.Title}}
                </div>
                {{end}}
                {{if gt .MoreCount 0}}
                <div class="month-event-more" onclick="event.stopPropagation(); showDayEventsModal('{{.Date.Format "2006-01-02"}}', this.parentElement)">
                    +{{.MoreCount}} more
                </div>
                {{end}}
            </div>
            {{end}}
        </div>
    </div>
    {{else if eq .View "week"}}
    <div class="week-view">
        <div class="view-title-nav">
            {{if .Calendars}}
            <div class="calendar-dropdown">
                <button type="button" class="calendar-dropdown-btn" onclick="toggleCalendarDropdown(event)">
                    <span>Calendars</span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="calendar-dropdown-menu">
                    {{range .Calendars}}
                    <div class="calendar-option" data-calendar-id="{{.ID}}">
                        <label class="calendar-checkbox">
                            <input type="checkbox" {{if .Visible}}checked{{end}}
                                   data-calendar-id="{{.ID}}"
                                   onchange="toggleCalendarVisibility('{{.ID}}', this.checked)">
                            <span class="checkmark" style="--cal-color: {{.Color}}"></span>
                        </label>
                        <span class="calendar-name">{{.Name}}</span>
                        <button type="button" class="calendar-color-btn"
                                style="background: {{.Color}}"
                                data-calendar-id="{{.ID}}"
                                data-current-color="{{.Color}}"
                                onclick="openColorPalette(event, '{{.ID}}')">
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
            <div class="view-title-row">
                <div class="view-title-left">
                    <button class="weather-widget" onclick="openWeatherModal()" title="Weather details">
                        <span class="weather-icon" id="weatherIconWeek"></span>
                        <span class="weather-temp" id="weatherTempWeek">--°</span>
                    </button>
                </div>
                <div class="view-title-center">
                    <a href="?view=week&date={{.PrevDate}}" class="nav-arrow"><img src="/icon/circle-arrow-left" alt="Previous"></a>
                    <h2 class="week-title" onclick="openDatePicker()">{{.WeekDateRange}}</h2>
                    <a href="?view=week&date={{.NextDate}}" class="nav-arrow"><img src="/icon/circle-arrow-right" alt="Next"></a>
                </div>
                <div class="view-title-right">
                    <button class="tasks-btn" onclick="toggleTasksPanel()" title="TODOs">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                        </svg>
                        <span>TODOs</span>
                    </button>
                </div>
            </div>
        </div>
        {{range .WeekDays}}
        <div class="week-day {{if .IsToday}}today{{end}}" data-date="{{.Date.Format "2006-01-02"}}">
            <div class="week-day-header" onclick="openCreateModal('{{.Date.Format "2006-01-02"}}')">
                <span class="week-day-name">{{.DayName}}</span>
                <span class="week-day-date">{{.DateStr}}</span>
                <span class="add-event-hint">+ Add</span>
            </div>
            <div class="week-day-events">
                {{range .Events}}
                <div class="event" {{if .Color}}style="border-left-color: {{.Color}}"{{end}}
                     data-event='{"id":"{{.ID}}","calendarId":"{{.CalendarID}}","title":"{{.Title}}","start":"{{.Start.Format "2006-01-02T15:04"}}","end":"{{.End.Format "2006-01-02T15:04"}}","allDay":{{.AllDay}},"location":"{{.Location}}","description":"{{.Description}}","colorId":"{{.ColorID}}","recurring":{{.Recurring}}}'
                     onclick="openEventDetails(this.dataset.event)">
                    <div class="event-time">
                        {{if .AllDay}}
                        <span class="all-day">All day</span>
                        {{else}}
                        {{formatTime .Start}}
                        {{end}}
                    </div>
                    <div class="event-details">
                        <div class="event-title">{{.Title}}</div>
                    </div>
                </div>
                {{end}}
                {{if not .Events}}
                <div class="no-events-small" onclick="openCreateModal('{{.Date.Format "2006-01-02"}}')">Tap to add event</div>
                {{end}}
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    {{/* Day view - 24-hour timeline */}}
    <div class="day-view">
        <div class="view-title-nav">
            {{if .Calendars}}
            <div class="calendar-dropdown">
                <button type="button" class="calendar-dropdown-btn" onclick="toggleCalendarDropdown(event)">
                    <span>Calendars</span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="calendar-dropdown-menu">
                    {{range .Calendars}}
                    <div class="calendar-option" data-calendar-id="{{.ID}}">
                        <label class="calendar-checkbox">
                            <input type="checkbox" {{if .Visible}}checked{{end}}
                                   data-calendar-id="{{.ID}}"
                                   onchange="toggleCalendarVisibility('{{.ID}}', this.checked)">
                            <span class="checkmark" style="--cal-color: {{.Color}}"></span>
                        </label>
                        <span class="calendar-name">{{.Name}}</span>
                        <button type="button" class="calendar-color-btn"
                                style="background: {{.Color}}"
                                data-calendar-id="{{.ID}}"
                                data-current-color="{{.Color}}"
                                onclick="openColorPalette(event, '{{.ID}}')">
                        </button>
                    </div>
                    {{end}}
                </div>
            </div>
            {{end}}
            <div class="view-title-row">
                <div class="view-title-left">
                    <button class="weather-widget" onclick="openWeatherModal()" title="Weather details">
                        <span class="weather-icon" id="weatherIconDay"></span>
                        <span class="weather-temp" id="weatherTempDay">--°</span>
                    </button>
                </div>
                <div class="view-title-center">
                    <a href="?view=day&date={{.PrevDate}}" class="nav-arrow"><img src="/icon/circle-arrow-left" alt="Previous"></a>
                    <h2 class="day-title" onclick="openDatePicker()">{{.DayDateStr}}</h2>
                    <a href="?view=day&date={{.NextDate}}" class="nav-arrow"><img src="/icon/circle-arrow-right" alt="Next"></a>
                </div>
                <div class="view-title-right">
                    <button class="tasks-btn" onclick="toggleTasksPanel()" title="TODOs">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11l3 3L22 4"/>
                            <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                        </svg>
                        <span>TODOs</span>
                    </button>
                </div>
            </div>
        </div>

        {{/* All-day events section */}}
        <div class="all-day-section">
            <div class="all-day-label">All Day</div>
            <div class="all-day-events">
                {{range .DayEvents}}
                {{if .AllDay}}
                <div class="all-day-event" {{if .Color}}style="background-color: {{.Color}}"{{end}}
                     data-event='{"id":"{{.ID}}","calendarId":"{{.CalendarID}}","title":"{{.Title}}","start":"{{.Start.Format "2006-01-02T15:04"}}","end":"{{.End.Format "2006-01-02T15:04"}}","allDay":{{.AllDay}},"location":"{{.Location}}","description":"{{.Description}}","colorId":"{{.ColorID}}","recurring":{{.Recurring}}}'
                     onclick="openEventDetails(this.dataset.event)">
                    {{.Title}}
                </div>
                {{end}}
                {{end}}
            </div>
        </div>

        {{/* Timeline */}}
        <div class="day-timeline" id="dayTimeline">
            {{range $hour := .Hours}}
            <div class="timeline-hour" data-hour="{{$hour}}">
                <div class="hour-label" data-hour="{{$hour}}"></div>
                <div class="hour-slot" onclick="openCreateModalAtHour('{{$.CurrentDate}}', {{$hour}})"></div>
            </div>
            {{end}}

            {{/* Events overlay */}}
            <div class="timeline-events">
                {{range .DayEvents}}
                {{if not .AllDay}}
                <div class="timeline-event"
                     {{if .Color}}style="background-color: {{.Color}}; --event-color: {{.Color}}"{{end}}
                     data-start="{{.Start.Format "15:04"}}"
                     data-end="{{.End.Format "15:04"}}"
                     data-event='{"id":"{{.ID}}","calendarId":"{{.CalendarID}}","title":"{{.Title}}","start":"{{.Start.Format "2006-01-02T15:04"}}","end":"{{.End.Format "2006-01-02T15:04"}}","allDay":{{.AllDay}},"location":"{{.Location}}","description":"{{.Description}}","colorId":"{{.ColorID}}","recurring":{{.Recurring}}}'
                     onclick="openEventDetails(this.dataset.event)">
                    <div class="timeline-event-time"></div>
                    <div class="timeline-event-title">{{.Title}}</div>
                    {{if .Location}}
                    <div class="timeline-event-location">{{.Location}}</div>
                    {{end}}
                </div>
                {{end}}
                {{end}}
            </div>
        </div>
    </div>
    {{end}}
    {{end}}
</div>

<!-- Event Details Modal -->
<div id="eventDetailsModal" class="modal" onclick="if(event.target===this)closeModal('eventDetailsModal')">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="detailsTitle">Event Details</h2>
            <button type="button" class="modal-close" onclick="closeModal('eventDetailsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="detail-row">
                <span class="detail-label">When</span>
                <span id="detailsWhen" class="detail-value"></span>
            </div>
            <div class="detail-row" id="detailsLocationRow">
                <span class="detail-label">Where</span>
                <span id="detailsLocation" class="detail-value"></span>
            </div>
            <div class="detail-row" id="detailsDescRow">
                <span class="detail-label">Notes</span>
                <span id="detailsDesc" class="detail-value"></span>
            </div>
            <div class="detail-row" id="detailsRecurringRow">
                <span class="detail-label">Recurring</span>
                <span id="detailsRecurring" class="detail-value">Yes</span>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-btn danger" onclick="confirmDeleteEvent()">Delete</button>
            <button type="button" class="modal-btn secondary" onclick="closeModal('eventDetailsModal')">Close</button>
            <button type="button" class="modal-btn primary" onclick="openEditModal()">Edit</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal" onclick="if(event.target===this)closeModal('deleteConfirmModal')">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Delete Event</h2>
            <button type="button" class="modal-close" onclick="closeModal('deleteConfirmModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete "<span id="deleteEventTitle"></span>"?</p>
            <p class="text-muted">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-btn secondary" onclick="closeModal('deleteConfirmModal')">Cancel</button>
            <button type="button" class="modal-btn danger" onclick="deleteEvent()">Delete</button>
        </div>
    </div>
</div>

<!-- Create Event Modal -->
<div id="createEventModal" class="modal" onclick="if(event.target===this)closeModal('createEventModal')">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2 id="modalTitle">New Event</h2>
            <button type="button" class="modal-close" onclick="closeModal('createEventModal')">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Event Type Toggle -->
            <div class="type-toggle">
                <button type="button" class="type-btn active" data-type="event" onclick="setEventType('event')">Event</button>
                <button type="button" class="type-btn" data-type="task" onclick="setEventType('task')">Task</button>
            </div>

            <div class="form-group">
                <label for="eventTitle">Title</label>
                <input type="text" id="eventTitle" class="form-input" placeholder="Event title">
            </div>

            <div class="form-group">
                <label for="eventDate">Date</label>
                <input type="date" id="eventDate" class="form-input">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allDayCheck" onchange="toggleTimeInputs()"> All day
                    </label>
                </div>
            </div>

            <div class="form-row time-inputs">
                <div class="form-group">
                    <label>Start Time</label>
                    <div class="time-picker" id="startTimePicker">
                        <div class="time-unit">
                            <button type="button" class="time-btn up" onclick="adjustTime('start', 'hour', 1)">▲</button>
                            <span class="time-field" id="startHour" onclick="activateTimeField(this, 'hour')">09</span>
                            <button type="button" class="time-btn down" onclick="adjustTime('start', 'hour', -1)">▼</button>
                        </div>
                        <span class="time-separator">:</span>
                        <div class="time-unit">
                            <button type="button" class="time-btn up" onclick="adjustTime('start', 'minute', 5)">▲</button>
                            <span class="time-field" id="startMinute" onclick="activateTimeField(this, 'minute')">00</span>
                            <button type="button" class="time-btn down" onclick="adjustTime('start', 'minute', -5)">▼</button>
                        </div>
                        <div class="time-unit ampm">
                            <button type="button" class="time-btn up" onclick="toggleAmPm('start')">▲</button>
                            <span class="time-field ampm-field" id="startAmPm" onclick="toggleAmPm('start')">AM</span>
                            <button type="button" class="time-btn down" onclick="toggleAmPm('start')">▼</button>
                        </div>
                    </div>
                    <input type="hidden" id="eventTime" value="09:00">
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <div class="time-picker" id="endTimePicker">
                        <div class="time-unit">
                            <button type="button" class="time-btn up" onclick="adjustTime('end', 'hour', 1)">▲</button>
                            <span class="time-field" id="endHour" onclick="activateTimeField(this, 'hour')">10</span>
                            <button type="button" class="time-btn down" onclick="adjustTime('end', 'hour', -1)">▼</button>
                        </div>
                        <span class="time-separator">:</span>
                        <div class="time-unit">
                            <button type="button" class="time-btn up" onclick="adjustTime('end', 'minute', 5)">▲</button>
                            <span class="time-field" id="endMinute" onclick="activateTimeField(this, 'minute')">00</span>
                            <button type="button" class="time-btn down" onclick="adjustTime('end', 'minute', -5)">▼</button>
                        </div>
                        <div class="time-unit ampm">
                            <button type="button" class="time-btn up" onclick="toggleAmPm('end')">▲</button>
                            <span class="time-field ampm-field" id="endAmPm" onclick="toggleAmPm('end')">AM</span>
                            <button type="button" class="time-btn down" onclick="toggleAmPm('end')">▼</button>
                        </div>
                    </div>
                    <input type="hidden" id="eventEndTime" value="10:00">
                </div>
            </div>

            <div class="form-group location-group">
                <label for="eventLocation">Location</label>
                <input type="text" id="eventLocation" class="form-input" placeholder="Add location"
                       autocomplete="off" oninput="searchPlaces(this.value)">
                <div id="locationSuggestions" class="location-suggestions"></div>
            </div>

            <div class="form-group">
                <label for="eventDescription">Description</label>
                <textarea id="eventDescription" class="form-input form-textarea" placeholder="Add description"></textarea>
            </div>

            <div class="form-group">
                <label for="eventRepeat">Repeat</label>
                <select id="eventRepeat" class="form-input">
                    <option value="">Does not repeat</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="yearly">Yearly</option>
                    <option value="weekdays">Every weekday (Mon-Fri)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Color</label>
                <div class="color-picker" id="colorPicker">
                    <button type="button" class="color-option active" data-color="" style="background: #4285f4" title="Default"></button>
                    <button type="button" class="color-option" data-color="1" style="background: #7986cb" title="Lavender"></button>
                    <button type="button" class="color-option" data-color="2" style="background: #33b679" title="Sage"></button>
                    <button type="button" class="color-option" data-color="3" style="background: #8e24aa" title="Grape"></button>
                    <button type="button" class="color-option" data-color="4" style="background: #e67c73" title="Flamingo"></button>
                    <button type="button" class="color-option" data-color="5" style="background: #f6c026" title="Banana"></button>
                    <button type="button" class="color-option" data-color="6" style="background: #f5511d" title="Tangerine"></button>
                    <button type="button" class="color-option" data-color="7" style="background: #039be5" title="Peacock"></button>
                    <button type="button" class="color-option" data-color="8" style="background: #616161" title="Graphite"></button>
                    <button type="button" class="color-option" data-color="9" style="background: #3f51b5" title="Blueberry"></button>
                    <button type="button" class="color-option" data-color="10" style="background: #0b8043" title="Basil"></button>
                    <button type="button" class="color-option" data-color="11" style="background: #d60000" title="Tomato"></button>
                </div>
                <input type="hidden" id="eventColor" value="">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-btn secondary" onclick="closeModal('createEventModal')">Cancel</button>
            <button type="button" class="modal-btn primary" id="createBtn" onclick="saveEvent()">Create Event</button>
        </div>
    </div>
</div>

<!-- Number Pad for Time Input -->
<div id="numberPad" class="number-pad">
    <div class="numpad-header">
        <span class="numpad-title">Enter Time</span>
        <button type="button" class="numpad-done" onclick="hideNumberPad()">Done</button>
    </div>
    <div class="numpad-grid">
        <button type="button" class="numpad-key" onclick="numpadInput('1')">1</button>
        <button type="button" class="numpad-key" onclick="numpadInput('2')">2</button>
        <button type="button" class="numpad-key" onclick="numpadInput('3')">3</button>
        <button type="button" class="numpad-key" onclick="numpadInput('4')">4</button>
        <button type="button" class="numpad-key" onclick="numpadInput('5')">5</button>
        <button type="button" class="numpad-key" onclick="numpadInput('6')">6</button>
        <button type="button" class="numpad-key" onclick="numpadInput('7')">7</button>
        <button type="button" class="numpad-key" onclick="numpadInput('8')">8</button>
        <button type="button" class="numpad-key" onclick="numpadInput('9')">9</button>
        <button type="button" class="numpad-key numpad-clear" onclick="numpadClear()">C</button>
        <button type="button" class="numpad-key" onclick="numpadInput('0')">0</button>
        <button type="button" class="numpad-key numpad-ok" onclick="hideNumberPad()">OK</button>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content modal-settings">
        <h3 class="modal-header">Settings</h3>

        <div class="settings-section">
            <h4 class="settings-section-title">Appearance</h4>
            <div class="form-group">
                <label>Theme</label>
                <div class="theme-options">
                    <button type="button" class="theme-option" data-theme="light" onclick="setTheme('light')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"/>
                            <line x1="12" y1="1" x2="12" y2="3"/>
                            <line x1="12" y1="21" x2="12" y2="23"/>
                            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                            <line x1="1" y1="12" x2="3" y2="12"/>
                            <line x1="21" y1="12" x2="23" y2="12"/>
                            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                        </svg>
                        <span>Light</span>
                    </button>
                    <button type="button" class="theme-option active" data-theme="dark" onclick="setTheme('dark')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                        </svg>
                        <span>Dark</span>
                    </button>
                    <button type="button" class="theme-option" data-theme="auto" onclick="setTheme('auto')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 2a10 10 0 0 1 0 20"/>
                        </svg>
                        <span>Auto</span>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label>Time Format</label>
                <div class="time-format-toggle">
                    <button type="button" class="format-btn" data-format="12" onclick="setTimeFormat('12')">
                        12-Hour
                    </button>
                    <button type="button" class="format-btn active" data-format="24" onclick="setTimeFormat('24')">
                        24-Hour
                    </button>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">Weather</h4>
            <div class="settings-info">
                {{if .WeatherConfigured}}
                <div class="weather-status connected">
                    <span class="status-dot"></span>
                    <span>Weather data enabled</span>
                </div>
                {{else}}
                <div class="weather-status disconnected">
                    <span class="status-dot"></span>
                    <span>Not configured</span>
                </div>
                <p class="settings-hint">Add OPENWEATHER_API_KEY to .env to enable weather features like sunrise/sunset times and moon phases.</p>
                {{end}}
            </div>
        </div>

        <div class="settings-section">
            <h4 class="settings-section-title">About</h4>
            <p class="settings-hint">Home Control Kiosk v1.0</p>
        </div>

        <div class="modal-actions">
            <button type="button" class="modal-btn primary" onclick="closeSettings()">Done</button>
        </div>
    </div>
</div>

<!-- Date Picker Modal -->
<div id="datePickerModal" class="modal">
    <div class="modal-content modal-small">
        <h3 class="modal-header">Go to Date</h3>
        <button type="button" class="today-btn" onclick="goToToday()">Today</button>
        <div class="date-picker-grid">
            <div class="form-group">
                <label>Month</label>
                <select id="datePickerMonth" class="form-input">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="form-group">
                <label>Year</label>
                <select id="datePickerYear" class="form-input"></select>
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="modal-btn secondary" onclick="closeDatePicker()">Cancel</button>
            <button type="button" class="modal-btn primary" onclick="goToDate()">Go</button>
        </div>
    </div>
</div>

<!-- TODOs Slide-out Panel -->
<div id="tasksPanel" class="tasks-panel">
    <div class="tasks-panel-header">
        <h3>TODOs</h3>
        <button class="tasks-panel-close" onclick="closeTasksPanel()">&times;</button>
    </div>
    <div class="tasks-panel-content">
        <div class="tasks-add-form">
            <input type="text" id="newTaskTitle" class="form-input" placeholder="Add a TODO..."
                   onkeydown="if(event.key==='Enter')createNewTask()">
            <button class="tasks-add-btn" onclick="createNewTask()">+</button>
        </div>
        <div id="tasksList" class="tasks-list">
            <div class="tasks-loading">Loading tasks...</div>
        </div>
        <div class="tasks-actions">
            <button class="tasks-clear-btn" onclick="clearCompletedTasks()">Clear completed</button>
        </div>
    </div>
</div>
<div id="tasksPanelOverlay" class="tasks-panel-overlay" onclick="closeTasksPanel()"></div>

<!-- Weather Modal -->
<div id="weatherModal" class="modal">
    <div class="modal-content modal-weather">
        <h3 class="modal-header">Weather</h3>
        <div id="weatherModalContent" class="weather-modal-content">
            <div class="weather-loading">Loading weather...</div>
        </div>
        <div class="modal-actions">
            <button type="button" class="modal-btn primary" onclick="closeWeatherModal()">Close</button>
        </div>
    </div>
</div>

<!-- Color Palette Popup -->
<div id="colorPalettePopup" class="color-palette-popup">
    <div class="color-palette-grid">
        <button type="button" class="color-swatch" data-color="#e94560" style="background: #e94560"></button>
        <button type="button" class="color-swatch" data-color="#f44336" style="background: #f44336"></button>
        <button type="button" class="color-swatch" data-color="#ff5722" style="background: #ff5722"></button>
        <button type="button" class="color-swatch" data-color="#ff9800" style="background: #ff9800"></button>
        <button type="button" class="color-swatch" data-color="#ffc107" style="background: #ffc107"></button>
        <button type="button" class="color-swatch" data-color="#8bc34a" style="background: #8bc34a"></button>
        <button type="button" class="color-swatch" data-color="#4caf50" style="background: #4caf50"></button>
        <button type="button" class="color-swatch" data-color="#009688" style="background: #009688"></button>
        <button type="button" class="color-swatch" data-color="#00bcd4" style="background: #00bcd4"></button>
        <button type="button" class="color-swatch" data-color="#03a9f4" style="background: #03a9f4"></button>
        <button type="button" class="color-swatch" data-color="#2196f3" style="background: #2196f3"></button>
        <button type="button" class="color-swatch" data-color="#3f51b5" style="background: #3f51b5"></button>
        <button type="button" class="color-swatch" data-color="#673ab7" style="background: #673ab7"></button>
        <button type="button" class="color-swatch" data-color="#9c27b0" style="background: #9c27b0"></button>
        <button type="button" class="color-swatch" data-color="#e91e63" style="background: #e91e63"></button>
        <button type="button" class="color-swatch" data-color="#795548" style="background: #795548"></button>
        <button type="button" class="color-swatch" data-color="#607d8b" style="background: #607d8b"></button>
        <button type="button" class="color-swatch" data-color="#9e9e9e" style="background: #9e9e9e"></button>
    </div>
</div>

<script>
let currentEventType = 'event';
let currentEvent = null; // Currently selected event for viewing/editing
let editMode = false; // Are we editing an existing event?

function openCreateModal(date) {
    editMode = false;
    currentEvent = null;
    const modal = document.getElementById('createEventModal');
    const dateInput = document.getElementById('eventDate');

    if (date) {
        dateInput.value = date;
    } else {
        dateInput.value = new Date().toISOString().split('T')[0];
    }

    // Reset all fields
    document.getElementById('eventTitle').value = '';
    document.getElementById('allDayCheck').checked = false;
    document.getElementById('eventTime').value = '09:00';
    document.getElementById('eventEndTime').value = '10:00';
    document.getElementById('eventLocation').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventRepeat').value = '';
    document.getElementById('eventColor').value = '';
    setEventType('event');
    toggleTimeInputs();
    setSelectedColor('');

    // Initialize time pickers with default values
    setTimePickerFromValue('start', '09:00');
    setTimePickerFromValue('end', '10:00');

    document.getElementById('modalTitle').textContent = 'New Event';
    document.getElementById('createBtn').textContent = 'Create Event';

    modal.classList.add('active');
}

function openEditModal() {
    if (!currentEvent) return;

    editMode = true;
    closeModal('eventDetailsModal');

    const modal = document.getElementById('createEventModal');
    const start = new Date(currentEvent.start);
    const end = new Date(currentEvent.end);

    // Populate form with event data
    document.getElementById('eventTitle').value = currentEvent.title || '';
    document.getElementById('eventDate').value = start.toISOString().split('T')[0];
    document.getElementById('allDayCheck').checked = currentEvent.allDay;

    const startTime = start.toTimeString().slice(0, 5);
    const endTime = end.toTimeString().slice(0, 5);
    document.getElementById('eventTime').value = startTime;
    document.getElementById('eventEndTime').value = endTime;

    // Set time pickers from event times
    setTimePickerFromValue('start', startTime);
    setTimePickerFromValue('end', endTime);

    document.getElementById('eventLocation').value = currentEvent.location || '';
    document.getElementById('eventDescription').value = currentEvent.description || '';
    document.getElementById('eventRepeat').value = '';
    document.getElementById('eventColor').value = currentEvent.colorId || '';
    setSelectedColor(currentEvent.colorId || '');
    toggleTimeInputs();

    document.getElementById('modalTitle').textContent = 'Edit Event';
    document.getElementById('createBtn').textContent = 'Save Changes';

    modal.classList.add('active');
}

function setEventType(type) {
    currentEventType = type;
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });

    if (!editMode) {
        document.getElementById('modalTitle').textContent = type === 'event' ? 'New Event' : 'New Task';
        document.getElementById('createBtn').textContent = type === 'event' ? 'Create Event' : 'Create Task';
    }

    // Tasks typically don't have end times
    const timeInputs = document.querySelector('.time-inputs');
    if (type === 'task') {
        document.getElementById('allDayCheck').checked = true;
        timeInputs.style.display = 'none';
    }
}

function openEventDetails(eventJson) {
    currentEvent = JSON.parse(eventJson);
    const modal = document.getElementById('eventDetailsModal');

    document.getElementById('detailsTitle').textContent = currentEvent.title;

    const start = new Date(currentEvent.start);
    const end = new Date(currentEvent.end);

    let whenText;
    if (currentEvent.allDay) {
        whenText = start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
    } else {
        whenText = start.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) +
                   ' at ' + start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) +
                   ' - ' + end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
    document.getElementById('detailsWhen').textContent = whenText;

    const locationRow = document.getElementById('detailsLocationRow');
    if (currentEvent.location) {
        document.getElementById('detailsLocation').textContent = currentEvent.location;
        locationRow.style.display = 'flex';
    } else {
        locationRow.style.display = 'none';
    }

    const descRow = document.getElementById('detailsDescRow');
    if (currentEvent.description) {
        document.getElementById('detailsDesc').textContent = currentEvent.description;
        descRow.style.display = 'flex';
    } else {
        descRow.style.display = 'none';
    }

    const recurringRow = document.getElementById('detailsRecurringRow');
    if (currentEvent.recurring) {
        recurringRow.style.display = 'flex';
    } else {
        recurringRow.style.display = 'none';
    }

    modal.classList.add('active');
}

function confirmDeleteEvent() {
    if (!currentEvent) return;

    document.getElementById('deleteEventTitle').textContent = currentEvent.title;
    document.getElementById('deleteConfirmModal').classList.add('active');
}

async function deleteEvent() {
    if (!currentEvent || !currentEvent.id) {
        alert('No event selected');
        return;
    }

    const calendarId = currentEvent.calendarId || 'primary';

    try {
        const resp = await fetch(`/api/calendar/event/${encodeURIComponent(calendarId)}/${encodeURIComponent(currentEvent.id)}`, {
            method: 'DELETE'
        });

        if (resp.ok || resp.status === 204) {
            closeModal('deleteConfirmModal');
            closeModal('eventDetailsModal');
            window.location.reload();
        } else {
            const err = await resp.text();
            alert('Failed to delete event: ' + err);
        }
    } catch (err) {
        alert('Error deleting event: ' + err.message);
    }
}

// Color picker handling
document.querySelectorAll('.color-option').forEach(btn => {
    btn.addEventListener('click', () => {
        setSelectedColor(btn.dataset.color);
    });
});

function setSelectedColor(colorId) {
    document.getElementById('eventColor').value = colorId;
    document.querySelectorAll('.color-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.color === colorId);
    });
}

function closeModal(id) {
    document.getElementById(id).classList.remove('active');
}

function toggleTimeInputs() {
    const allDay = document.getElementById('allDayCheck').checked;
    document.querySelector('.time-inputs').style.display = allDay ? 'none' : 'flex';
}

async function saveEvent() {
    const title = document.getElementById('eventTitle').value.trim();
    const date = document.getElementById('eventDate').value;
    const allDay = document.getElementById('allDayCheck').checked;
    const time = document.getElementById('eventTime').value;
    const endTime = document.getElementById('eventEndTime').value;
    const eventLocation = document.getElementById('eventLocation').value.trim();
    const description = document.getElementById('eventDescription').value.trim();
    const repeat = document.getElementById('eventRepeat').value;
    const colorId = document.getElementById('eventColor').value;

    if (!title || !date) {
        alert('Please enter a title and date');
        return;
    }

    const data = {
        type: currentEventType,
        title: title,
        date: date,
        time: allDay ? '' : time,
        endTime: allDay ? '' : endTime,
        location: eventLocation,
        description: description,
        repeat: repeat,
        colorId: colorId
    };

    try {
        let url, method;

        if (editMode && currentEvent && currentEvent.id) {
            // Update existing event
            const calendarId = currentEvent.calendarId || 'primary';
            url = `/api/calendar/event/${encodeURIComponent(calendarId)}/${encodeURIComponent(currentEvent.id)}`;
            method = 'PUT';
        } else {
            // Create new event
            url = '/api/calendar/event';
            method = 'POST';
        }

        const resp = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (resp.ok) {
            const result = await resp.json();
            console.log(editMode ? 'Event updated:' : 'Event created:', result);
            closeModal('createEventModal');
            window.location.reload();
        } else {
            const err = await resp.text();
            alert(`Failed to ${editMode ? 'update' : 'create'} event: ` + err);
        }
    } catch (err) {
        alert(`Error ${editMode ? 'updating' : 'creating'} event: ` + err.message);
    }
}

// Time Picker Functions
let activeTimeField = null;
let activeTimeType = null; // 'hour' or 'minute'
let activeTimePrefix = null; // 'start' or 'end'

function adjustTime(prefix, field, delta) {
    const element = document.getElementById(prefix + capitalize(field));
    let value = parseInt(element.textContent);

    if (field === 'hour') {
        value += delta;
        if (value > 12) value = 1;
        if (value < 1) value = 12;
        element.textContent = value.toString().padStart(2, '0');
    } else if (field === 'minute') {
        value += delta;
        if (value >= 60) value = 0;
        if (value < 0) value = 55;
        element.textContent = value.toString().padStart(2, '0');
    }

    updateHiddenTimeInput(prefix);
}

function toggleAmPm(prefix) {
    const element = document.getElementById(prefix + 'AmPm');
    element.textContent = element.textContent === 'AM' ? 'PM' : 'AM';
    updateHiddenTimeInput(prefix);
}

function activateTimeField(element, type) {
    // Deactivate previous field
    if (activeTimeField) {
        activeTimeField.classList.remove('active');
    }

    // Get prefix from element id
    const id = element.id;
    activeTimePrefix = id.startsWith('start') ? 'start' : 'end';
    activeTimeType = type;
    activeTimeField = element;
    element.classList.add('active');

    // Show number pad
    showNumberPad();
}

function showNumberPad() {
    const numpad = document.getElementById('numberPad');
    if (numpad) {
        numpad.classList.add('active');
        document.body.classList.add('numpad-open');
    }
}

function hideNumberPad() {
    const numpad = document.getElementById('numberPad');
    if (numpad) {
        numpad.classList.remove('active');
        document.body.classList.remove('numpad-open');
    }
    if (activeTimeField) {
        activeTimeField.classList.remove('active');
        activeTimeField = null;
    }
}

function numpadInput(digit) {
    if (!activeTimeField || activeTimeType === null) return;

    const current = activeTimeField.textContent;
    let newValue;

    if (activeTimeType === 'hour') {
        // For hours: shift left and add digit (max 12)
        newValue = (parseInt(current.slice(-1) + digit));
        if (newValue > 12) newValue = parseInt(digit);
        if (newValue === 0) newValue = 12;
        activeTimeField.textContent = newValue.toString().padStart(2, '0');
    } else if (activeTimeType === 'minute') {
        // For minutes: shift left and add digit (max 59)
        newValue = parseInt(current.slice(-1) + digit);
        if (newValue > 59) newValue = parseInt(digit);
        activeTimeField.textContent = newValue.toString().padStart(2, '0');
    }

    updateHiddenTimeInput(activeTimePrefix);
}

function numpadClear() {
    if (activeTimeField) {
        activeTimeField.textContent = '00';
        if (activeTimeType === 'hour') {
            activeTimeField.textContent = '12';
        }
        updateHiddenTimeInput(activeTimePrefix);
    }
}

function updateHiddenTimeInput(prefix) {
    const hour = parseInt(document.getElementById(prefix + 'Hour').textContent);
    const minute = document.getElementById(prefix + 'Minute').textContent;
    const ampm = document.getElementById(prefix + 'AmPm').textContent;

    // Convert to 24-hour format
    let hour24 = hour;
    if (ampm === 'PM' && hour !== 12) {
        hour24 = hour + 12;
    } else if (ampm === 'AM' && hour === 12) {
        hour24 = 0;
    }

    const timeValue = hour24.toString().padStart(2, '0') + ':' + minute;
    const hiddenInput = document.getElementById(prefix === 'start' ? 'eventTime' : 'eventEndTime');
    hiddenInput.value = timeValue;
}

function setTimePickerFromValue(prefix, time24) {
    if (!time24) return;

    const [hours, minutes] = time24.split(':').map(Number);
    let hour12 = hours % 12;
    if (hour12 === 0) hour12 = 12;
    const ampm = hours >= 12 ? 'PM' : 'AM';

    document.getElementById(prefix + 'Hour').textContent = hour12.toString().padStart(2, '0');
    document.getElementById(prefix + 'Minute').textContent = minutes.toString().padStart(2, '0');
    document.getElementById(prefix + 'AmPm').textContent = ampm;
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Location Autocomplete
let placesSearchTimeout = null;

function searchPlaces(query) {
    if (placesSearchTimeout) {
        clearTimeout(placesSearchTimeout);
    }

    const suggestions = document.getElementById('locationSuggestions');

    if (!query || query.length < 3) {
        suggestions.classList.remove('active');
        suggestions.innerHTML = '';
        return;
    }

    // Debounce the search
    placesSearchTimeout = setTimeout(async () => {
        try {
            const resp = await fetch(`/api/places/autocomplete?input=${encodeURIComponent(query)}`);
            if (resp.ok) {
                const data = await resp.json();
                displayPlaceSuggestions(data.predictions || []);
            }
        } catch (err) {
            console.error('Places search error:', err);
        }
    }, 300);
}

function displayPlaceSuggestions(predictions) {
    const suggestions = document.getElementById('locationSuggestions');

    if (predictions.length === 0) {
        suggestions.classList.remove('active');
        suggestions.innerHTML = '';
        return;
    }

    suggestions.innerHTML = predictions.map(p => `
        <div class="location-suggestion" onclick="selectPlace('${escapeHtml(p.description)}')">
            <span class="suggestion-icon">📍</span>
            <span class="suggestion-text">${escapeHtml(p.description)}</span>
        </div>
    `).join('');

    suggestions.classList.add('active');
}

function selectPlace(place) {
    document.getElementById('eventLocation').value = place;
    document.getElementById('locationSuggestions').classList.remove('active');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Hide suggestions when clicking outside
document.addEventListener('click', (e) => {
    if (!e.target.closest('.location-group')) {
        document.getElementById('locationSuggestions').classList.remove('active');
    }
});

// Date Picker Functions
const currentView = '{{.View}}';
const currentDate = '{{.CurrentDate}}';

function openDatePicker() {
    const modal = document.getElementById('datePickerModal');
    const monthSelect = document.getElementById('datePickerMonth');
    const yearSelect = document.getElementById('datePickerYear');

    // Parse current date
    const [year, month] = currentDate.split('-').map(Number);

    // Populate year dropdown (10 years back, 5 years forward)
    yearSelect.innerHTML = '';
    const currentYear = new Date().getFullYear();
    for (let y = currentYear - 10; y <= currentYear + 5; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        if (y === year) option.selected = true;
        yearSelect.appendChild(option);
    }

    // Set current month
    monthSelect.value = month;

    modal.classList.add('active');
}

function closeDatePicker() {
    document.getElementById('datePickerModal').classList.remove('active');
}

function goToDate() {
    const month = document.getElementById('datePickerMonth').value.padStart(2, '0');
    const year = document.getElementById('datePickerYear').value;
    const date = `${year}-${month}-01`;
    window.location.href = `?view=${currentView}&date=${date}`;
}

function goToToday() {
    const today = new Date().toISOString().split('T')[0];
    window.location.href = `?view=${currentView}&date=${today}`;
}

function showDayEventsModal(dateStr, dayElement) {
    // Get all month-event elements in this day cell
    const eventElements = dayElement.querySelectorAll('.month-event');
    const events = [];

    eventElements.forEach(el => {
        if (el.dataset.event) {
            events.push(JSON.parse(el.dataset.event));
        }
    });

    // Also check if there's hidden event data for overflow
    if (dayElement.dataset.allEvents) {
        const allEvents = JSON.parse(dayElement.dataset.allEvents);
        // Use all events instead
        showEventsListModal(dateStr, allEvents);
        return;
    }

    showEventsListModal(dateStr, events);
}

// Store events for modal access
let dayEventsModalData = [];

function showEventsListModal(dateStr, events) {
    dayEventsModalData = events;
    const date = new Date(dateStr + 'T12:00:00');
    const dateTitle = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

    let html = `
        <div class="modal-content modal-day-events">
            <div class="modal-header-row">
                <div class="modal-header-title">
                    <h3>${dateTitle}</h3>
                </div>
                <button class="modal-close-btn" onclick="closeDayEventsModal()">&times;</button>
            </div>
            <div class="day-events-list">
    `;

    events.forEach((event, index) => {
        const startTime = event.allDay ? 'All day' : new Date(event.start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        html += `
            <div class="day-events-item" onclick="openEventFromDayModal(${index})">
                <div class="day-events-time">${startTime}</div>
                <div class="day-events-title">${escapeHtml(event.title)}</div>
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;

    // Create or reuse modal
    let modal = document.getElementById('dayEventsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'dayEventsModal';
        modal.className = 'modal';
        document.body.appendChild(modal);
    }

    modal.innerHTML = html;
    modal.classList.add('active');
}

function closeDayEventsModal() {
    const modal = document.getElementById('dayEventsModal');
    if (modal) {
        modal.classList.remove('active');
    }
}

function openEventFromDayModal(index) {
    const event = dayEventsModalData[index];
    if (event) {
        closeDayEventsModal();
        openEventDetails(JSON.stringify(event));
    }
}

// Calendar Dropdown Functions
function toggleCalendarDropdown(event) {
    event.stopPropagation();
    const menu = document.querySelector('.calendar-dropdown-menu');
    if (menu) {
        menu.classList.toggle('open');
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.calendar-dropdown-menu')) {
        const menu = document.querySelector('.calendar-dropdown-menu');
        if (menu) {
            menu.classList.remove('open');
        }
    }
});

// Calendar Filter Functions
function filterCalendars() {
    const checkboxes = document.querySelectorAll('.calendar-option input[type="checkbox"]');
    const activeCalendarIds = new Set();

    checkboxes.forEach(cb => {
        if (cb.checked) {
            activeCalendarIds.add(cb.dataset.calendarId);
        }
    });

    // Filter events
    document.querySelectorAll('[data-event]').forEach(el => {
        try {
            const event = JSON.parse(el.dataset.event);
            if (activeCalendarIds.has(event.calendarId)) {
                el.style.display = '';
            } else {
                el.style.display = 'none';
            }
        } catch (e) {}
    });
}

// Toggle calendar visibility and save to server
async function toggleCalendarVisibility(calendarId, visible) {
    // Get current color for this calendar
    const colorBtn = document.querySelector(`.calendar-option[data-calendar-id="${calendarId}"] .calendar-color-btn`);
    const color = colorBtn ? colorBtn.dataset.currentColor : '';

    try {
        const response = await fetch(`/api/calendar/prefs/${encodeURIComponent(calendarId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ visible: visible, color: color })
        });

        if (!response.ok) {
            console.error('Failed to save calendar preference');
        }
    } catch (err) {
        console.error('Error saving calendar preference:', err);
    }

    // Apply filter immediately
    filterCalendars();
}

// Update calendar color and save to server
async function updateCalendarColor(calendarId, color) {
    // Get current visibility for this calendar
    const checkbox = document.querySelector(`.calendar-option[data-calendar-id="${calendarId}"] input[type="checkbox"]`);
    const visible = checkbox ? checkbox.checked : true;

    try {
        const response = await fetch(`/api/calendar/prefs/${encodeURIComponent(calendarId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ visible: visible, color: color })
        });

        if (!response.ok) {
            console.error('Failed to save calendar color');
            return;
        }

        // Update the checkmark color in the dropdown
        const checkmark = document.querySelector(`.calendar-option[data-calendar-id="${calendarId}"] .checkmark`);
        if (checkmark) {
            checkmark.style.setProperty('--cal-color', color);
        }

        // Update the color button background
        const colorBtn = document.querySelector(`.calendar-option[data-calendar-id="${calendarId}"] .calendar-color-btn`);
        if (colorBtn) {
            colorBtn.style.background = color;
            colorBtn.dataset.currentColor = color;
        }

        // Update all events from this calendar with new color
        document.querySelectorAll('[data-event]').forEach(el => {
            try {
                const event = JSON.parse(el.dataset.event);
                if (event.calendarId === calendarId) {
                    // Update inline styles based on element type
                    if (el.style.backgroundColor) {
                        el.style.backgroundColor = color;
                    }
                    if (el.style.borderLeftColor) {
                        el.style.borderLeftColor = color;
                    }
                    el.style.setProperty('--event-color', color);
                }
            } catch (e) {}
        });

    } catch (err) {
        console.error('Error saving calendar color:', err);
    }
}

// Color palette state
let colorPaletteCalendarId = null;

// Open color palette popup
function openColorPalette(event, calendarId) {
    event.stopPropagation();
    const popup = document.getElementById('colorPalettePopup');
    const btn = event.currentTarget;

    colorPaletteCalendarId = calendarId;

    // Position the popup near the button but ensure it stays in viewport
    const btnRect = btn.getBoundingClientRect();
    const popupWidth = 200;
    const popupHeight = 160;

    let left = btnRect.left;
    let top = btnRect.bottom + 8;

    // Ensure popup stays within viewport
    if (left + popupWidth > window.innerWidth) {
        left = window.innerWidth - popupWidth - 16;
    }
    if (left < 16) {
        left = 16;
    }
    if (top + popupHeight > window.innerHeight) {
        top = btnRect.top - popupHeight - 8;
    }

    popup.style.left = left + 'px';
    popup.style.top = top + 'px';
    popup.classList.add('open');
}

// Close color palette popup
function closeColorPalette() {
    const popup = document.getElementById('colorPalettePopup');
    popup.classList.remove('open');
    colorPaletteCalendarId = null;
}

// Handle color swatch click
document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('colorPalettePopup');
    if (popup) {
        popup.addEventListener('click', function(e) {
            const swatch = e.target.closest('.color-swatch');
            if (swatch && colorPaletteCalendarId) {
                const color = swatch.dataset.color;
                updateCalendarColor(colorPaletteCalendarId, color);
                closeColorPalette();
            }
        });
    }

    // Close palette when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.color-palette-popup') && !e.target.closest('.calendar-color-btn')) {
            closeColorPalette();
        }
    });
});

// Initialize calendar filtering on page load
document.addEventListener('DOMContentLoaded', function() {
    filterCalendars();
});

// Settings Functions
function openSettings() {
    const modal = document.getElementById('settingsModal');
    modal.classList.add('active');
    loadThemeSetting();
    loadTimeFormatSetting();
}

function closeSettings() {
    document.getElementById('settingsModal').classList.remove('active');
}

function setTheme(theme) {
    localStorage.setItem('theme', theme);
    applyTheme(theme);

    // Update button states
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
    });
}

function loadThemeSetting() {
    const theme = localStorage.getItem('theme') || 'dark';
    document.querySelectorAll('.theme-option').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.theme === theme);
    });
}

function applyTheme(theme) {
    if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
    } else {
        document.documentElement.setAttribute('data-theme', theme);
    }
}

// Apply theme on load
(function() {
    const theme = localStorage.getItem('theme') || 'dark';
    applyTheme(theme);
})();

// Listen for system theme changes when in auto mode
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    const theme = localStorage.getItem('theme');
    if (theme === 'auto') {
        applyTheme('auto');
    }
});

// Time Format Functions
function getTimeFormat() {
    return localStorage.getItem('timeFormat') || '12';
}

function setTimeFormat(format) {
    localStorage.setItem('timeFormat', format);
    document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.format === format);
    });
    // Re-render time labels
    updateTimeLabels();
    updateTimelineEventTimes();
}

function loadTimeFormatSetting() {
    const format = getTimeFormat();
    document.querySelectorAll('.format-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.format === format);
    });
}

function formatHour(hour) {
    const format = getTimeFormat();
    if (format === '24') {
        return hour.toString().padStart(2, '0') + ':00';
    } else {
        if (hour === 0) return '12 AM';
        if (hour === 12) return '12 PM';
        if (hour < 12) return hour + ' AM';
        return (hour - 12) + ' PM';
    }
}

function formatTimeValue(time24) {
    const format = getTimeFormat();
    const [hours, minutes] = time24.split(':').map(Number);

    if (format === '24') {
        return hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0');
    } else {
        let h = hours % 12;
        if (h === 0) h = 12;
        const ampm = hours >= 12 ? 'PM' : 'AM';
        return h + ':' + minutes.toString().padStart(2, '0') + ' ' + ampm;
    }
}

function updateTimeLabels() {
    document.querySelectorAll('.hour-label').forEach(label => {
        const hour = parseInt(label.dataset.hour);
        label.textContent = formatHour(hour);
    });
}

function updateTimelineEventTimes() {
    document.querySelectorAll('.timeline-event').forEach(event => {
        const start = event.dataset.start;
        const end = event.dataset.end;
        const timeEl = event.querySelector('.timeline-event-time');
        if (timeEl && start) {
            timeEl.textContent = formatTimeValue(start) + ' - ' + formatTimeValue(end);
        }
    });
}

// Timeline Functions
function initDayTimeline() {
    const timeline = document.getElementById('dayTimeline');
    if (!timeline) return;

    // Update hour labels
    updateTimeLabels();

    // Position events
    positionTimelineEvents();

    // Add current time line (only for today)
    addCurrentTimeLine();

    // Scroll to current time
    scrollToCurrentTime();
}

function positionTimelineEvents() {
    const events = document.querySelectorAll('.timeline-event');
    const hourHeight = 60; // matches CSS .timeline-hour height

    events.forEach(event => {
        const start = event.dataset.start;
        const end = event.dataset.end;

        if (!start || !end) return;

        const [startHour, startMin] = start.split(':').map(Number);
        const [endHour, endMin] = end.split(':').map(Number);

        // Calculate position (in pixels from top)
        const startMinutes = startHour * 60 + startMin;
        const endMinutes = endHour * 60 + endMin;

        const top = (startMinutes / 60) * hourHeight;
        const height = Math.max(((endMinutes - startMinutes) / 60) * hourHeight, 24); // min height 24px

        event.style.top = top + 'px';
        event.style.height = height + 'px';

        // Update time display
        const timeEl = event.querySelector('.timeline-event-time');
        if (timeEl) {
            timeEl.textContent = formatTimeValue(start) + ' - ' + formatTimeValue(end);
        }
    });
}

function addCurrentTimeLine() {
    const timeline = document.getElementById('dayTimeline');
    if (!timeline) return;

    // Check if viewing today
    const viewDate = '{{.CurrentDate}}';
    const today = new Date().toISOString().split('T')[0];
    if (viewDate !== today) return;

    // Remove existing line if any
    const existing = timeline.querySelector('.current-time-line');
    if (existing) existing.remove();

    // Create and position the line
    const now = new Date();
    const minutes = now.getHours() * 60 + now.getMinutes();
    const hourHeight = 60;
    const top = (minutes / 60) * hourHeight;

    const line = document.createElement('div');
    line.className = 'current-time-line';
    line.style.top = top + 'px';

    timeline.querySelector('.timeline-events').appendChild(line);
}

function scrollToCurrentTime() {
    const timeline = document.getElementById('dayTimeline');
    if (!timeline) return;

    const now = new Date();
    const hourHeight = 60;

    // Calculate scroll position (current hour - 2 hours padding at top)
    const currentMinutes = now.getHours() * 60 + now.getMinutes();
    const scrollTo = Math.max(0, (currentMinutes / 60) * hourHeight - 120);

    timeline.scrollTop = scrollTo;
}

function openCreateModalAtHour(date, hour) {
    openCreateModal(date);

    // Set the start time to the clicked hour
    const format = getTimeFormat();
    let hour12 = hour % 12;
    if (hour12 === 0) hour12 = 12;
    const ampm = hour < 12 ? 'AM' : 'PM';

    document.getElementById('startHour').textContent = hour12.toString().padStart(2, '0');
    document.getElementById('startMinute').textContent = '00';
    document.getElementById('startAmPm').textContent = ampm;
    document.getElementById('eventTime').value = hour.toString().padStart(2, '0') + ':00';

    // Set end time to 1 hour later
    const endHour = (hour + 1) % 24;
    let endHour12 = endHour % 12;
    if (endHour12 === 0) endHour12 = 12;
    const endAmpm = endHour < 12 ? 'AM' : 'PM';

    document.getElementById('endHour').textContent = endHour12.toString().padStart(2, '0');
    document.getElementById('endMinute').textContent = '00';
    document.getElementById('endAmPm').textContent = endAmpm;
    document.getElementById('eventEndTime').value = endHour.toString().padStart(2, '0') + ':00';

    // Make sure all-day is unchecked
    document.getElementById('allDayCheck').checked = false;
    toggleTimeInputs();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Init day timeline if on day view
    initDayTimeline();

    // Load time format setting
    loadTimeFormatSetting();

    // Update current time line every minute
    setInterval(() => {
        addCurrentTimeLine();
    }, 60000);
});

// ===== Weather Functions =====
let weatherData = null;

async function loadWeather() {
    try {
        const resp = await fetch('/api/weather');
        if (!resp.ok) {
            throw new Error('Weather not available');
        }
        weatherData = await resp.json();
        updateWeatherWidget();
    } catch (err) {
        console.log('Weather not configured or unavailable');
        // Hide weather widgets if not available
        document.querySelectorAll('.weather-widget').forEach(el => {
            el.style.display = 'none';
        });
    }
}

function updateWeatherWidget() {
    if (!weatherData || !weatherData.current) return;

    const temp = Math.round(weatherData.current.temp);
    const icon = getWeatherEmoji(weatherData.current.icon);

    // Update all weather widgets (one per view)
    ['Month', 'Week', 'Day'].forEach(view => {
        const iconEl = document.getElementById('weatherIcon' + view);
        const tempEl = document.getElementById('weatherTemp' + view);
        if (iconEl) iconEl.textContent = icon;
        if (tempEl) tempEl.textContent = temp + '°';
    });
}

function getWeatherEmoji(iconCode) {
    const icons = {
        'sun': '☀️',
        'moon': '🌙',
        'cloud-sun': '⛅',
        'cloud': '☁️',
        'clouds': '☁️',
        'cloud-rain': '🌧️',
        'cloud-showers': '🌧️',
        'bolt': '⚡',
        'snowflake': '❄️',
        'smog': '🌫️'
    };
    return icons[iconCode] || '🌤️';
}

function getMoonPhase(date = new Date()) {
    // Calculate moon phase (0-29.53 day cycle)
    // Reference: January 6, 2000 was a new moon
    const reference = new Date(2000, 0, 6, 18, 14, 0);
    const diff = date - reference;
    const days = diff / (1000 * 60 * 60 * 24);
    const lunarCycle = 29.53058770576;
    const phase = ((days % lunarCycle) + lunarCycle) % lunarCycle;

    // Return phase info
    if (phase < 1.85) return { emoji: '🌑', name: 'New Moon' };
    if (phase < 5.53) return { emoji: '🌒', name: 'Waxing Crescent' };
    if (phase < 9.22) return { emoji: '🌓', name: 'First Quarter' };
    if (phase < 12.91) return { emoji: '🌔', name: 'Waxing Gibbous' };
    if (phase < 16.61) return { emoji: '🌕', name: 'Full Moon' };
    if (phase < 20.30) return { emoji: '🌖', name: 'Waning Gibbous' };
    if (phase < 23.99) return { emoji: '🌗', name: 'Last Quarter' };
    if (phase < 27.68) return { emoji: '🌘', name: 'Waning Crescent' };
    return { emoji: '🌑', name: 'New Moon' };
}

function openWeatherModal() {
    if (!weatherData) {
        alert('Weather data not available');
        return;
    }

    const modal = document.getElementById('weatherModal');
    const content = document.getElementById('weatherModalContent');

    content.innerHTML = renderWeatherContent();
    modal.classList.add('active');
}

function closeWeatherModal() {
    document.getElementById('weatherModal').classList.remove('active');
}

function renderWeatherContent() {
    if (!weatherData) return '<div class="weather-error">Weather data not available</div>';

    const current = weatherData.current;
    const hourly = weatherData.hourly || [];
    const daily = weatherData.daily || [];
    const moonPhase = getMoonPhase();

    // Format sunrise/sunset times
    const sunrise = new Date(current.sunrise * 1000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    const sunset = new Date(current.sunset * 1000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

    let html = `
        <div class="weather-current">
            <div class="weather-current-main">
                <span class="weather-current-icon">${getWeatherEmoji(current.icon)}</span>
                <div class="weather-current-info">
                    <span class="weather-current-temp">${Math.round(current.temp)}°</span>
                    <span class="weather-current-condition">${current.condition}</span>
                </div>
            </div>
            <div class="weather-current-details">
                <div class="weather-detail">
                    <span class="weather-detail-icon">🌡️</span>
                    <span class="weather-detail-value">${Math.round(current.feelsLike)}°</span>
                    <span class="weather-detail-label">Feels like</span>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">💧</span>
                    <span class="weather-detail-value">${current.humidity}%</span>
                    <span class="weather-detail-label">Humidity</span>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">💨</span>
                    <span class="weather-detail-value">${Math.round(current.windSpeed)}</span>
                    <span class="weather-detail-label">mph</span>
                </div>
                <div class="weather-detail">
                    <span class="weather-detail-icon">☁️</span>
                    <span class="weather-detail-value">${current.clouds}%</span>
                    <span class="weather-detail-label">Clouds</span>
                </div>
            </div>
            <div class="weather-sun-moon">
                <div class="weather-sun"><span class="sun-icon">🌅</span><span class="sun-time">${sunrise}</span></div>
                <div class="weather-sun"><span class="sun-icon">🌇</span><span class="sun-time">${sunset}</span></div>
                <div class="weather-moon"><span class="moon-icon">${moonPhase.emoji}</span><span class="moon-phase">${moonPhase.name}</span></div>
            </div>
        </div>
    `;

    // Hourly forecast - filter to only current day
    const today = new Date();
    const todayStr = today.toDateString();
    const todayHourly = hourly.filter(hour => {
        const hourDate = new Date(hour.time * 1000);
        return hourDate.toDateString() === todayStr;
    });

    if (todayHourly.length > 0) {
        html += '<div class="weather-section">';
        html += '<div class="weather-section-title">Today</div>';
        html += '<div class="weather-hourly">';
        todayHourly.forEach((hour) => {
            const time = new Date(hour.time * 1000);
            const timeStr = time.toLocaleTimeString('en-US', { hour: 'numeric' });
            html += `
                <div class="weather-hourly-item">
                    <div class="hourly-time">${timeStr}</div>
                    <div class="hourly-icon">${getWeatherEmoji(hour.icon)}</div>
                    <div class="hourly-temp">${Math.round(hour.temp)}°</div>
                    ${hour.pop > 0.1 ? `<div class="hourly-pop">${Math.round(hour.pop * 100)}%</div>` : ''}
                </div>
            `;
        });
        html += '</div>';
        html += '</div>';
    }

    // Daily forecast
    if (daily.length > 0) {
        html += '<div class="weather-section">';
        html += '<div class="weather-section-title">5-Day Forecast</div>';
        html += '<div class="weather-daily">';
        daily.forEach((day, i) => {
            const date = new Date(day.time * 1000);
            const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
            html += `
                <div class="weather-daily-item">
                    <div class="daily-day">${dayName}</div>
                    <div class="daily-icon">${getWeatherEmoji(day.icon)}</div>
                    ${day.pop > 0.1 ? `<div class="daily-pop">💧 ${Math.round(day.pop * 100)}%</div>` : '<div class="daily-pop"></div>'}
                    <div class="daily-temps">
                        <span class="daily-high">${Math.round(day.tempMax)}°</span>
                        <span class="daily-low">${Math.round(day.tempMin)}°</span>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        html += '</div>';
    }

    return html;
}

// Load weather on page load
document.addEventListener('DOMContentLoaded', () => {
    loadWeather();

    // Close modals when clicking outside (on the backdrop)
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            // Only close if clicking directly on the modal backdrop, not its children
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });
    });
});

// ===== Tasks Panel Functions =====
let currentListId = '@default';
let tasksLoaded = false;

function toggleTasksPanel() {
    const panel = document.getElementById('tasksPanel');
    const overlay = document.getElementById('tasksPanelOverlay');
    const isOpen = panel.classList.contains('active');

    if (isOpen) {
        closeTasksPanel();
    } else {
        panel.classList.add('active');
        overlay.classList.add('active');
        document.body.classList.add('tasks-panel-open');
        if (!tasksLoaded) {
            loadTasks();
        }
    }
}

function closeTasksPanel() {
    document.getElementById('tasksPanel').classList.remove('active');
    document.getElementById('tasksPanelOverlay').classList.remove('active');
    document.body.classList.remove('tasks-panel-open');
}

async function loadTasks() {
    const tasksList = document.getElementById('tasksList');
    tasksList.innerHTML = '<div class="tasks-loading">Loading tasks...</div>';

    try {
        const resp = await fetch(`/api/tasks?listId=${encodeURIComponent(currentListId)}`);
        if (!resp.ok) {
            throw new Error('Failed to load tasks');
        }
        const tasks = await resp.json();
        tasksLoaded = true;
        renderTasks(tasks || []);
    } catch (err) {
        console.error('Error loading tasks:', err);
        tasksList.innerHTML = '<div class="tasks-error">Failed to load TODOs. Make sure Google Tasks is authorized.</div>';
    }
}

function renderTasks(tasks) {
    const tasksList = document.getElementById('tasksList');

    if (tasks.length === 0) {
        tasksList.innerHTML = '<div class="tasks-empty">No TODOs yet. Add one above!</div>';
        return;
    }

    // Update currentListId with the actual resolved list ID from tasks
    if (tasks[0] && tasks[0].listId) {
        currentListId = tasks[0].listId;
    }

    tasksList.innerHTML = tasks.map(task => `
        <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}" data-list-id="${task.listId}">
            <button class="task-checkbox" onclick="toggleTask('${task.listId}', '${task.id}')">
                ${task.completed ? '&#10003;' : ''}
            </button>
            <span class="task-title">${escapeHtml(task.title)}</span>
            <button class="task-delete" onclick="deleteTask('${task.listId}', '${task.id}')">&times;</button>
        </div>
    `).join('');
}

async function createNewTask() {
    const input = document.getElementById('newTaskTitle');
    const title = input.value.trim();

    if (!title) return;

    input.disabled = true;

    try {
        const resp = await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                listId: currentListId,
                title: title
            })
        });

        if (resp.ok) {
            input.value = '';
            loadTasks();
        } else {
            const err = await resp.text();
            console.error('Failed to create task:', err);
        }
    } catch (err) {
        console.error('Error creating task:', err);
    } finally {
        input.disabled = false;
        input.focus();
    }
}

async function toggleTask(listId, taskId) {
    const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskEl) {
        taskEl.classList.add('loading');
    }

    try {
        const resp = await fetch(`/api/tasks/${encodeURIComponent(listId)}/${encodeURIComponent(taskId)}/toggle`, {
            method: 'POST'
        });

        if (resp.ok) {
            const task = await resp.json();
            if (taskEl) {
                taskEl.classList.toggle('completed', task.completed);
                taskEl.querySelector('.task-checkbox').innerHTML = task.completed ? '&#10003;' : '';
            }
        }
    } catch (err) {
        console.error('Error toggling task:', err);
    } finally {
        if (taskEl) {
            taskEl.classList.remove('loading');
        }
    }
}

async function deleteTask(listId, taskId) {
    const taskEl = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskEl) {
        taskEl.classList.add('deleting');
    }

    try {
        const resp = await fetch(`/api/tasks/${encodeURIComponent(listId)}/${encodeURIComponent(taskId)}`, {
            method: 'DELETE'
        });

        if (resp.ok || resp.status === 204) {
            if (taskEl) {
                taskEl.remove();
            }
            // Check if list is now empty
            const remaining = document.querySelectorAll('.task-item');
            if (remaining.length === 0) {
                document.getElementById('tasksList').innerHTML = '<div class="tasks-empty">No tasks yet. Add one above!</div>';
            }
        }
    } catch (err) {
        console.error('Error deleting task:', err);
        if (taskEl) {
            taskEl.classList.remove('deleting');
        }
    }
}

async function clearCompletedTasks() {
    try {
        const resp = await fetch(`/api/tasks/${encodeURIComponent(currentListId)}/clear`, {
            method: 'POST'
        });

        if (resp.ok || resp.status === 204) {
            loadTasks();
        }
    } catch (err) {
        console.error('Error clearing completed tasks:', err);
    }
}

// ===== Calendar Event Auto-Refresh =====
let lastEventsHash = '';

// Create a simple hash from events data
function hashEvents(events) {
    if (!events || !Array.isArray(events)) return '';
    return events.map(e => `${e.ID}:${e.Title}:${e.Start}:${e.End}`).sort().join('|');
}

// Check for new/changed events periodically
async function checkForEventUpdates() {
    // Don't refresh if a modal is open (user is interacting)
    const activeModal = document.querySelector('.modal.active');
    if (activeModal) {
        console.log('Skipping calendar refresh - modal is open');
        return;
    }

    try {
        const resp = await fetch(`/api/calendar/events?view=${currentView}&date=${currentDate}`);
        if (!resp.ok) {
            console.log('Calendar refresh: API error');
            return;
        }

        const events = await resp.json();
        const newHash = hashEvents(events);

        // Initialize hash on first check
        if (lastEventsHash === '') {
            lastEventsHash = newHash;
            console.log('Calendar refresh: initialized events hash');
            return;
        }

        // If events changed, reload the page
        if (newHash !== lastEventsHash) {
            console.log('Calendar refresh: events changed, reloading...');
            lastEventsHash = newHash;
            window.location.reload();
        }
    } catch (err) {
        console.error('Calendar refresh error:', err);
    }
}

// Check for updates every 60 seconds
setInterval(checkForEventUpdates, 60000);

// Also check once shortly after page load to initialize the hash
setTimeout(checkForEventUpdates, 5000);
</script>

<!-- Camera/Doorbell WebSocket Module -->
<script src="/static/js/camera.js"></script>

<!-- Camera Modal -->
<div id="cameraModal" class="modal camera-modal">
    <div class="modal-content modal-camera">
        <div class="modal-header-row">
            <div class="modal-header-title">
                <span class="camera-modal-icon">🔔</span>
                <h3 id="cameraModalTitle">Doorbell</h3>
            </div>
            <button class="modal-close-btn" onclick="closeCameraModal()">&times;</button>
        </div>
        <div class="camera-stream-container">
            <img id="cameraStream" class="camera-stream" alt="Camera stream">
            <div class="camera-loading">Loading camera...</div>
        </div>
        <div class="camera-modal-actions">
            <button class="modal-btn secondary" onclick="closeCameraModal()">Dismiss</button>
        </div>
    </div>
</div>

<!-- Screensaver Overlay -->
<div id="screensaver" class="screensaver">
    <div class="screensaver-bg"></div>
    <div class="screensaver-bg screensaver-bg-next"></div>
    <div class="screensaver-clock">
        <div class="screensaver-time" id="screensaverTime">12:00</div>
        <div class="screensaver-date" id="screensaverDate">Monday, January 1</div>
    </div>
</div>

<!-- Background Image Container -->
<div id="pageBackground" class="page-background"></div>

<script>
// Screensaver and Background Image System
(function() {
    let screensaverConfig = { timeout: 300, hasScreensaverFolder: false, hasBackgroundFolder: false };
    let inactivityTimer = null;
    let screensaverPhotoTimer = null;
    let screensaverActive = false;
    let screensaverPhotos = [];
    let currentPhotoIndex = 0;
    let currentBgElement = 0;

    // Check if a video modal is currently open (don't activate screensaver over videos)
    function isVideoModalOpen() {
        return document.querySelector('#cameraModal.active, #camerasModal.active, #cameraViewModal.active') !== null;
    }

    // Load screensaver config
    async function loadScreensaverConfig() {
        try {
            const resp = await fetch('/api/screensaver/config');
            if (resp.ok) {
                screensaverConfig = await resp.json();
                console.log('Screensaver config loaded:', screensaverConfig);

                if (screensaverConfig.hasScreensaverFolder) {
                    loadScreensaverPhotos();
                }
                if (screensaverConfig.hasBackgroundFolder) {
                    loadBackgroundPhoto();
                }

                // Start inactivity tracking if timeout is configured (photos are optional)
                if (screensaverConfig.timeout > 0) {
                    startInactivityTracking();
                    console.log(`Screensaver will activate after ${screensaverConfig.timeout} seconds of inactivity`);
                }
            }
        } catch (err) {
            console.log('Screensaver not configured:', err);
        }
    }

    // Load all screensaver photos
    async function loadScreensaverPhotos() {
        try {
            const resp = await fetch('/api/drive/screensaver/photos');
            if (resp.ok) {
                screensaverPhotos = await resp.json();
                console.log(`Loaded ${screensaverPhotos.length} screensaver photos`);
                // Shuffle the photos
                screensaverPhotos.sort(() => Math.random() - 0.5);
            }
        } catch (err) {
            console.error('Failed to load screensaver photos:', err);
        }
    }

    // Load a random background photo
    async function loadBackgroundPhoto() {
        try {
            const resp = await fetch('/api/drive/background/random');
            if (resp.ok) {
                const photo = await resp.json();
                const bg = document.getElementById('pageBackground');
                if (bg && photo.id) {
                    // Use our proxy endpoint for authentication
                    const photoUrl = `/api/drive/photo/${photo.id}`;
                    bg.style.backgroundImage = `url(${photoUrl})`;
                    bg.classList.add('active');
                    console.log(`Background photo loaded: ${photo.name}`);
                }
            }
        } catch (err) {
            console.log('No background photo available');
        }
    }

    // Inactivity tracking
    function startInactivityTracking() {
        const events = ['mousedown', 'mousemove', 'keydown', 'touchstart', 'scroll', 'click'];

        function resetTimer() {
            if (screensaverActive) {
                hideScreensaver();
            }

            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                showScreensaver();
            }, screensaverConfig.timeout * 1000);
        }

        events.forEach(event => {
            document.addEventListener(event, resetTimer, { passive: true });
        });

        // Start the initial timer
        resetTimer();
    }

    // Show screensaver
    function showScreensaver() {
        if (screensaverActive) return;

        // Don't activate screensaver if a video modal is open (e.g., camera/doorbell)
        if (isVideoModalOpen()) {
            console.log('Screensaver skipped: video modal is open');
            return;
        }

        screensaverActive = true;

        const screensaver = document.getElementById('screensaver');
        screensaver.classList.add('active');

        // Update clock immediately
        updateScreensaverClock();

        // Start clock updates
        setInterval(updateScreensaverClock, 1000);

        // Show first photo
        if (screensaverPhotos.length > 0) {
            showNextPhoto();
            // Cycle photos every 10 seconds
            screensaverPhotoTimer = setInterval(showNextPhoto, 10000);
        }
    }

    // Hide screensaver
    function hideScreensaver() {
        if (!screensaverActive) return;
        screensaverActive = false;

        const screensaver = document.getElementById('screensaver');
        screensaver.classList.remove('active');

        // Stop photo cycling
        if (screensaverPhotoTimer) {
            clearInterval(screensaverPhotoTimer);
            screensaverPhotoTimer = null;
        }
    }

    // Update screensaver clock
    function updateScreensaverClock() {
        const now = new Date();
        const timeEl = document.getElementById('screensaverTime');
        const dateEl = document.getElementById('screensaverDate');

        if (timeEl) {
            timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
        if (dateEl) {
            dateEl.textContent = now.toLocaleDateString([], {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
        }
    }

    // Show next photo with crossfade
    function showNextPhoto() {
        if (screensaverPhotos.length === 0) return;

        const photo = screensaverPhotos[currentPhotoIndex];
        // Use our proxy endpoint which handles OAuth authentication
        const photoUrl = `/api/drive/photo/${photo.id}`;

        console.log(`Loading screensaver photo: ${photo.name} (${photo.id})`);

        const bgs = document.querySelectorAll('.screensaver-bg');
        const currentBg = bgs[currentBgElement];
        const nextBg = bgs[1 - currentBgElement];

        // Preload the image before showing
        const img = new Image();
        img.onload = () => {
            nextBg.style.backgroundImage = `url(${photoUrl})`;
            nextBg.classList.add('active');
            setTimeout(() => {
                currentBg.classList.remove('active');
            }, 1500);
            currentBgElement = 1 - currentBgElement;
        };
        img.onerror = () => {
            console.error(`Failed to load photo: ${photo.name}`);
        };
        img.src = photoUrl;

        currentPhotoIndex = (currentPhotoIndex + 1) % screensaverPhotos.length;
    }

    // Click/touch to dismiss screensaver
    document.getElementById('screensaver').addEventListener('click', hideScreensaver);
    document.getElementById('screensaver').addEventListener('touchstart', hideScreensaver);

    // Expose hideScreensaver globally for doorbell events
    window.dismissScreensaver = hideScreensaver;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', loadScreensaverConfig);
})();
</script>
{{end}}
